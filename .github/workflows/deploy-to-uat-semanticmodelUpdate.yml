name: Deploy Semantic Model to UAT

on:
  push:
    branches: [UAT_branch]
  pull_request:
    branches: [UAT_branch]

jobs:
  update-uat-semanticmodel-params:
    if: github.ref == 'refs/heads/UAT_branch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq (for parsing JSON)
        run: sudo apt-get install jq

      - name: Update expressions.tmdl in all folders using UAT config
        run: |
          CONFIG="deploy-config-semanticmodelUpdate.json"
          echo "üì¶ Reading UAT values from $CONFIG..."
          Catalog=$(jq -r '.uat.Catalog_Param' $CONFIG)
          Schema=$(jq -r '.uat.Schema_Param' $CONFIG)
          Host=$(jq -r '.uat.Host_param' $CONFIG)
          HttpPath=$(jq -r '.uat.HttpPath_param' $CONFIG)

          echo "üîç Finding all expressions.tmdl files‚Ä¶"
          find ./SematicModels_Folder -type f -path "*/definition/expressions.tmdl" -print0 \
          | while IFS= read -r -d '' TMDL; do
            echo "  ‚Ä¢ Found $TMDL"
            sed -i "s/\(expression\s\+Catalog_Param\s*=\s*\)\".*\"/\1\"$Catalog\"/" "$TMDL"
            sed -i "s/\(expression\s\+Schema_Param\s*=\s*\)\".*\"/\1\"$Schema\"/" "$TMDL"
            sed -i "s/\(expression\s\+Host_param\s*=\s*\)\".*\"/\1\"$Host\"/" "$TMDL"
            sed -i "s|\(expression\s\+HttpPath_param\s*=\s*\)\".*\"|\1\"$HttpPath\"|" "$TMDL"
          done
          echo "‚úÖ All expressions.tmdl updated for UAT."

      - name: Show updated expressions.tmdl (for logs)
        run: |
          find ./SematicModels_Folder -type f -path "*/definition/expressions.tmdl" -exec cat {} \;

      - name: Commit and push updated expressions.tmdl files
        if: github.ref == 'refs/heads/UAT_branch'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # Debugging: print the files we intend to add
          echo "Files to commit:"
          find ./SematicModels_Folder -type f -path "*/definition/expressions.tmdl" -print0

          # Stage all expressions.tmdl files found
          git add $(find ./SematicModels_Folder -type f -path "*/definition/expressions.tmdl" -print0)

          git commit -m "Auto-update expressions.tmdl with UAT values" || echo "No changes to commit"
          git push origin UAT_branch || echo "No changes to push"
