name: Deploy Semantic Model to UAT

on:
  push:
    branches: [UAT_branch]
  pull_request:
    branches: [UAT_branch]

jobs:
  update-uat-semanticmodel-params:
    if: github.ref == 'refs/heads/UAT_branch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq (for parsing JSON)
        run: sudo apt-get install jq

      - name: Update expressions.tmdl in all SemanticModel folders using UAT config
        run: |
          CONFIG_FILE="deploy-config-semanticmodelUpdate.json"

          echo "üì¶ Reading UAT values from $CONFIG_FILE..."
          Catalog_Param=$(jq -r '.uat.Catalog_Param' $CONFIG_FILE)
          Catalog_param=$(jq -r '.uat.Catalog_param // empty' $CONFIG_FILE)
          Schema_Param=$(jq -r '.uat.Schema_Param' $CONFIG_FILE)
          Schema_param=$(jq -r '.uat.Schema_param // empty' $CONFIG_FILE)
          Host=$(jq -r '.uat.Host_param' $CONFIG_FILE)
          HttpPath=$(jq -r '.uat.HttpPath_param' $CONFIG_FILE)

          echo "üîç Looking for all SemanticModel folders‚Ä¶"
          for DIR in ./SematicModels_Folder/*.SemanticModel; do
            TMDL_FILE="$DIR/definition/expressions.tmdl"

            if [ -f "$TMDL_FILE" ]; then
              echo "  ‚Ä¢ Updating $TMDL_FILE"

              # Catalog
              sed -i "s|\(expression\s\+Catalog_Param\s*=\s*\)\"[^\"]*\"|\1\"$Catalog_Param\"|" "$TMDL_FILE"
              if [ -n "$Catalog_param" ]; then
                sed -i "s|\(expression\s\+Catalog_param\s*=\s*\)\"[^\"]*\"|\1\"$Catalog_param\"|" "$TMDL_FILE"
              fi

              # Schema
              sed -i "s|\(expression\s\+Schema_Param\s*=\s*\)\"[^\"]*\"|\1\"$Schema_Param\"|" "$TMDL_FILE"
              if [ -n "$Schema_param" ]; then
                sed -i "s|\(expression\s\+Schema_param\s*=\s*\)\"[^\"]*\"|\1\"$Schema_param\"|" "$TMDL_FILE"
              fi

              # Host and HttpPath
              sed -i "s|\(expression\s\+Host_param\s*=\s*\)\"[^\"]*\"|\1\"$Host\"|" "$TMDL_FILE"
              sed -i "s|\(expression\s\+HttpPath_param\s*=\s*\)\"[^\"]*\"|\1\"$HttpPath\"|" "$TMDL_FILE"
            else
              echo "  ‚ö†Ô∏è No expressions.tmdl found in $DIR/definition"
            fi
          done

          echo "‚úÖ All expressions.tmdl updated for UAT."

      - name: Show updated expressions.tmdl (for logs)
        run: |
          for DIR in ./SematicModels_Folder/*.SemanticModel; do
            TMDL_FILE="$DIR/definition/expressions.tmdl"
            if [ -f "$TMDL_FILE" ]; then
              echo "üìÑ Showing $TMDL_FILE"
              cat "$TMDL_FILE"
            fi
          done

      - name: Commit and push changes back to UAT branch
        if: github.ref == 'refs/heads/UAT_branch'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add ./SematicModels_Folder/*.SemanticModel/definition/expressions.tmdl
          git commit -m "Auto-update expressions.tmdl with UAT values" || echo "No changes to commit"
          git push origin UAT_branch || echo "No changes to push"
