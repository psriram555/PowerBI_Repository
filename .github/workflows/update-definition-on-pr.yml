name: Deploy Linked Reports to Power BI UAT

on:
  push:
    branches:
      - uat

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Power BI CLI
      run: |
        npm install -g powerbi-cli
        powerbi --version

    - name: Authenticate with Power BI using Service Principal
      run: |
        powerbi login \
          --service-principal \
          --client-id ${{ secrets.PBI_CLIENT_ID }} \
          --client-secret ${{ secrets.PBI_CLIENT_SECRET }} \
          --tenant ${{ secrets.PBI_TENANT_ID }}

    - name: Deploy all PBIP Linked Reports to UAT
      run: |
        for folder in $(find . -mindepth 1 -maxdepth 1 -type d); do
          if [ -f "$folder/definition.pbir" ]; then
            echo "Deploying $folder to Power BI UAT workspace..."
            powerbi report import \
              --workspace-id ${{ secrets.PBI_WORKSPACE_ID_UAT }} \
              --name "$(basename $folder)" \
              --pbip-path "$folder" \
              --verbose
          fi
        done
